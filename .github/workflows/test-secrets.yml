name: Test Secrets Only

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install dependencies
      run: pip install requests
    
    - name: Test Secrets Directly
      env:
        TENANT_ID: ${{ secrets.TENANT_ID }}
        CLIENT_ID: ${{ secrets.CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: |
        python3 << 'PYTHON_SCRIPT'
        import requests
        import os
        import sys
        import json

        def test_secrets():
            print("\n" + "="*80)
            print("GITHUB SECRETS VALIDATION TEST")
            print("="*80)
            
            # Get secrets
            secrets = {
                'TENANT_ID': os.environ.get('TENANT_ID', ''),
                'CLIENT_ID': os.environ.get('CLIENT_ID', ''),
                'CLIENT_SECRET': os.environ.get('CLIENT_SECRET', ''),
                'REFRESH_TOKEN': os.environ.get('REFRESH_TOKEN', '')
            }
            
            # Check if secrets exist
            print("\n[STEP 1] Checking if secrets exist...")
            for name, value in secrets.items():
                if value:
                    print(f"  ✓ {name}: EXISTS (length: {len(value)})")
                else:
                    print(f"  ✗ {name}: MISSING")
                    return False
            
            # Check for whitespace issues
            print("\n[STEP 2] Checking for whitespace issues...")
            whitespace_issues = False
            for name, value in secrets.items():
                stripped = value.strip()
                if value != stripped:
                    print(f"  ✗ {name}: HAS WHITESPACE (original: {len(value)}, stripped: {len(stripped)})")
                    whitespace_issues = True
                    # Show invisible characters
                    print(f"     First char code: {ord(value[0])}")
                    print(f"     Last char code: {ord(value[-1])}")
                else:
                    print(f"  ✓ {name}: No whitespace issues")
            
            if whitespace_issues:
                print("\n  [WARNING] Whitespace detected! Auto-stripping for test...")
                secrets = {k: v.strip() for k, v in secrets.items()}
            
            # Check for newlines
            print("\n[STEP 3] Checking for newline characters...")
            for name, value in secrets.items():
                if '\n' in value or '\r' in value:
                    print(f"  ✗ {name}: CONTAINS NEWLINES")
                    print(f"     Newlines: {value.count(chr(10))}")
                    print(f"     Carriage returns: {value.count(chr(13))}")
                else:
                    print(f"  ✓ {name}: No newlines")
            
            # Display partial values
            print("\n[STEP 4] Partial secret values (for verification)...")
            for name, value in secrets.items():
                if len(value) > 20:
                    display = f"{value[:10]}...{value[-10:]}"
                else:
                    display = f"{value[:5]}...{value[-3:]}"
                print(f"  {name}: {display}")
            
            # Test authentication
            print("\n[STEP 5] Testing authentication with Microsoft...")
            print("-"*80)
            
            url = f"https://login.microsoftonline.com/{secrets['TENANT_ID']}/oauth2/v2.0/token"
            
            data = {
                'grant_type': 'refresh_token',
                'client_id': secrets['CLIENT_ID'],
                'client_secret': secrets['CLIENT_SECRET'],
                'refresh_token': secrets['REFRESH_TOKEN'],
                'scope': 'https://graph.microsoft.com/Files.Read.All offline_access'
            }
            
            print(f"  Token URL: {url}")
            print(f"  Grant type: refresh_token")
            print(f"  Scope: Files.Read.All offline_access")
            print("\n  Sending request...")
            
            try:
                response = requests.post(url, data=data, timeout=30)
                
                print(f"\n  Response Status: {response.status_code}")
                
                if response.status_code == 200:
                    print("\n" + "="*80)
                    print("✓✓✓ SUCCESS! AUTHENTICATION WORKS! ✓✓✓")
                    print("="*80)
                    
                    token_data = response.json()
                    print(f"\n  Access Token: {token_data['access_token'][:30]}...")
                    
                    if 'refresh_token' in token_data:
                        new_token = token_data['refresh_token']
                        print(f"\n  [CRITICAL] NEW REFRESH TOKEN ISSUED!")
                        print(f"  [ACTION REQUIRED] Update GitHub Secret REFRESH_TOKEN with:")
                        print("\n" + "-"*80)
                        print(new_token)
                        print("-"*80)
                        
                        # Check if token changed
                        if new_token != secrets['REFRESH_TOKEN']:
                            print("\n  [NOTICE] Token has changed - this is normal")
                            print("  [TODO] Update GitHub Secret to avoid future failures")
                        else:
                            print("\n  [INFO] Token unchanged (same as current)")
                    
                    print("\n  [RESULT] Your GitHub Secrets are configured correctly!")
                    return True
                    
                else:
                    print("\n" + "="*80)
                    print("✗✗✗ AUTHENTICATION FAILED ✗✗✗")
                    print("="*80)
                    
                    try:
                        error_data = response.json()
                        print(f"\n  Error Code: {error_data.get('error', 'Unknown')}")
                        print(f"  Description: {error_data.get('error_description', 'No description')}")
                        print(f"\n  Full Error Response:")
                        print(json.dumps(error_data, indent=2))
                        
                        # Provide specific guidance
                        error_code = error_data.get('error', '')
                        error_desc = error_data.get('error_description', '')
                        
                        print("\n[DIAGNOSIS]")
                        
                        if 'AADSTS70000' in error_desc or 'expired' in error_desc.lower():
                            print("  → Refresh token has EXPIRED")
                            print("  → Run refresh_token_renewer_windows.py locally")
                            print("  → Update REFRESH_TOKEN secret with new token")
                        
                        elif 'AADSTS700016' in error_desc:
                            print("  → CLIENT_ID is INCORRECT or app not found")
                            print("  → Verify CLIENT_ID in GitHub Secrets")
                            print("  → Check Azure AD app registration")
                        
                        elif 'AADSTS7000215' in error_desc:
                            print("  → CLIENT_SECRET is INVALID")
                            print("  → Verify CLIENT_SECRET in GitHub Secrets")
                            print("  → Check if secret expired in Azure AD")
                        
                        elif 'invalid_grant' in error_code:
                            print("  → REFRESH_TOKEN is INVALID or expired")
                            print("  → Generate new token with refresh_token_renewer_windows.py")
                            print("  → Check for whitespace/newlines in token")
                        
                        else:
                            print("  → Unknown authentication error")
                            print("  → Check all secrets are correct")
                            print("  → Verify Azure AD app configuration")
                            
                    except:
                        print(f"\n  Raw Response: {response.text}")
                    
                    return False
                    
            except requests.exceptions.RequestException as e:
                print(f"\n✗ Network Error: {e}")
                return False
            except Exception as e:
                print(f"\n✗ Unexpected Error: {e}")
                import traceback
                traceback.print_exc()
                return False

        # Run the test
        if test_secrets():
            print("\n[FINAL STATUS] ✓ ALL TESTS PASSED")
            sys.exit(0)
        else:
            print("\n[FINAL STATUS] ✗ TESTS FAILED - See diagnostics above")
            sys.exit(1)

        PYTHON_SCRIPT
