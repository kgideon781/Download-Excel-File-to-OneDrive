name: Download CARTA Files with Debugging

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  download-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Debug - Check Environment Variables Length
      env:
        TENANT_ID: ${{ secrets.TENANT_ID }}
        CLIENT_ID: ${{ secrets.CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: |
        echo "=== ENVIRONMENT VARIABLE DIAGNOSTICS ==="
        echo "TENANT_ID length: ${#TENANT_ID}"
        echo "CLIENT_ID length: ${#CLIENT_ID}"
        echo "CLIENT_SECRET length: ${#CLIENT_SECRET}"
        echo "REFRESH_TOKEN length: ${#REFRESH_TOKEN}"
        echo ""
        echo "TENANT_ID first 8 chars: ${TENANT_ID:0:8}"
        echo "CLIENT_ID first 8 chars: ${CLIENT_ID:0:8}"
        echo "CLIENT_SECRET first 8 chars: ${CLIENT_SECRET:0:8}"
        echo "REFRESH_TOKEN first 10 chars: ${REFRESH_TOKEN:0:10}"
        echo ""
        echo "Checking for whitespace issues..."
        if [ "$TENANT_ID" != "$(echo -n $TENANT_ID)" ]; then
          echo "WARNING: TENANT_ID has whitespace!"
        fi
        if [ "$CLIENT_ID" != "$(echo -n $CLIENT_ID)" ]; then
          echo "WARNING: CLIENT_ID has whitespace!"
        fi
        if [ "$CLIENT_SECRET" != "$(echo -n $CLIENT_SECRET)" ]; then
          echo "WARNING: CLIENT_SECRET has whitespace!"
        fi
        if [ "$REFRESH_TOKEN" != "$(echo -n $REFRESH_TOKEN)" ]; then
          echo "WARNING: REFRESH_TOKEN has whitespace!"
        fi
        echo "=== END DIAGNOSTICS ==="
    
    - name: Test Authentication First
      env:
        TENANT_ID: ${{ secrets.TENANT_ID }}
        CLIENT_ID: ${{ secrets.CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: |
        python3 << 'EOF'
        import requests
        import os
        import sys

        print("\n" + "="*70)
        print("AUTHENTICATION TEST")
        print("="*70)

        # Strip whitespace from all secrets
        tenant_id = os.environ['TENANT_ID'].strip()
        client_id = os.environ['CLIENT_ID'].strip()
        client_secret = os.environ['CLIENT_SECRET'].strip()
        refresh_token = os.environ['REFRESH_TOKEN'].strip()

        print(f"\n[DEBUG] TENANT_ID: {tenant_id[:8]}...{tenant_id[-4:]}")
        print(f"[DEBUG] CLIENT_ID: {client_id[:8]}...{client_id[-4:]}")
        print(f"[DEBUG] CLIENT_SECRET: {client_secret[:8]}...{client_secret[-4:]}")
        print(f"[DEBUG] REFRESH_TOKEN length: {len(refresh_token)}")
        print(f"[DEBUG] REFRESH_TOKEN first 10: {refresh_token[:10]}")
        print(f"[DEBUG] REFRESH_TOKEN last 10: {refresh_token[-10:]}")

        # Check for common issues
        if '\n' in refresh_token:
            print("[ERROR] REFRESH_TOKEN contains newline characters!")
        if '\r' in refresh_token:
            print("[ERROR] REFRESH_TOKEN contains carriage return characters!")
        if ' ' in refresh_token and not refresh_token.strip():
            print("[ERROR] REFRESH_TOKEN is only whitespace!")

        url = f"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token"
        
        data = {
            'grant_type': 'refresh_token',
            'client_id': client_id,
            'client_secret': client_secret,
            'refresh_token': refresh_token,
            'scope': 'https://graph.microsoft.com/Files.Read.All offline_access'
        }

        print(f"\n[DEBUG] Token URL: {url}")
        print("[DEBUG] Attempting authentication...")

        try:
            response = requests.post(url, data=data, timeout=30)
            
            print(f"[DEBUG] Response status: {response.status_code}")
            print(f"[DEBUG] Response headers: {dict(response.headers)}")
            
            if response.status_code == 200:
                print("\n[SUCCESS] Authentication successful!")
                token_data = response.json()
                print(f"[SUCCESS] Access token received: {token_data['access_token'][:20]}...")
                
                if 'refresh_token' in token_data:
                    print(f"\n[IMPORTANT] New refresh token issued!")
                    print(f"[IMPORTANT] Update GitHub Secret with this:")
                    print(token_data['refresh_token'])
                
                sys.exit(0)
            else:
                print(f"\n[ERROR] Authentication failed!")
                print(f"[ERROR] Status: {response.status_code}")
                
                try:
                    error_data = response.json()
                    print(f"[ERROR] Error: {error_data.get('error', 'Unknown')}")
                    print(f"[ERROR] Description: {error_data.get('error_description', 'No description')}")
                    print(f"[ERROR] Full response: {error_data}")
                except:
                    print(f"[ERROR] Raw response: {response.text}")
                
                sys.exit(1)
                
        except Exception as e:
            print(f"\n[ERROR] Exception occurred: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
    
    - name: Download via Delegated Authentication
      if: success()
      env:
        TENANT_ID: ${{ secrets.TENANT_ID }}
        CLIENT_ID: ${{ secrets.CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      run: python download_delegated_improved.py
    
    - name: Upload downloaded files
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: carta-files-${{ github.run_number }}
        path: data/
        retention-days: 30
    
    - name: Commit and push changes
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data/
        git diff --quiet && git diff --staged --quiet || git commit -m "Update CARTA files - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
